<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClaimFix.ai - Medical Billing Denial Resolution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-bg-dark: #0f172a;
            --color-card-dark: #1e293b;
            --color-primary: #3b82f6;
            --color-secondary: #8b5cf6;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-text-light: #f8fafc;
            --color-text-muted: #94a3b8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-dark);
            color: var(--color-text-light);
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 0 1rem;
        }

        @media (min-width: 768px) {
            .container {
                padding: 0 2rem;
            }
        }

        @media (min-width: 1024px) {
            .container {
                max-width: 1280px;
            }
        }

        .main-card {
            background-color: var(--color-card-dark);
            border-radius: 0.75rem;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 0.5rem;
            color: var(--color-text-muted);
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background-color: #334155;
            color: var(--color-text-light);
        }

        .active-nav {
            background-color: var(--color-primary);
            color: white !important;
            font-weight: 600;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--color-primary);
            animation: spin 1s linear infinite;
            width: 1.5rem;
            height: 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        input, select, textarea {
            background-color: #334155 !important;
            border: 1px solid #475569 !important;
            color: var(--color-text-light) !important;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary) !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast-success {
            background-color: #10b981;
        }

        .toast-error {
            background-color: #ef4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .confidence-high { color: #10b981; }
        .confidence-medium { color: #f59e0b; }
        .confidence-low { color: #ef4444; }

        .risk-critical { background-color: #ef4444; color: white; }
        .risk-high { background-color: #f59e0b; color: white; }
        .risk-medium { background-color: #3b82f6; color: white; }
        .risk-low { background-color: #10b981; color: white; }

        .code-valid { color: #10b981; }
        .code-warning { color: #f59e0b; }
        .code-error { color: #ef4444; }

        .accuracy-score {
            font-size: 3rem;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .validation-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .validation-success { background-color: #10b98120; color: #10b981; }
        .validation-warning { background-color: #f59e0b20; color: #f59e0b; }
        .validation-error { background-color: #ef444420; color: #ef4444; }

        .accuracy-meter {
            position: relative;
            width: 100%;
            height: 8px;
            background-color: #334155;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .accuracy-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .accuracy-marker {
            position: absolute;
            top: -4px;
            width: 2px;
            height: 16px;
            background-color: white;
            transform: translateX(-50%);
        }

        .suggestion-item {
            padding: 0.75rem;
            background-color: #334155;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid transparent;
        }

        .suggestion-critical { border-left-color: #ef4444; }
        .suggestion-important { border-left-color: #f59e0b; }
        .suggestion-helpful { border-left-color: #3b82f6; }
    </style>
</head>
<body>
    <div class="min-h-screen bg-slate-900">
        <!-- Header -->
        <header class="bg-slate-800 border-b border-slate-700">
            <div class="container py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-extrabold text-xl shadow-lg">
                            <i class="fas fa-file-medical-alt"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-extrabold text-white">ClaimFix.ai</h1>
                            <p class="text-xs text-slate-400">Medical Billing Denial Resolution Platform</p>
                        </div>
                    </div>
                    <div class="hidden md:flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-xs text-slate-400">Accuracy Score</p>
                            <p class="text-lg font-bold text-green-400">98.7%</p>
                        </div>
                        <button id="apiStatus" class="px-3 py-1 rounded-full text-xs font-medium bg-green-900/30 text-green-400">
                            <i class="fas fa-circle text-xs mr-1"></i>
                            AI Active
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container py-6">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Sidebar -->
                <div class="lg:col-span-3">
                    <div class="main-card p-4 sticky top-6">
                        <nav class="space-y-1">
                            <button data-view="resolver" class="nav-item active-nav w-full text-left">
                                <i class="fas fa-magic w-5 mr-3"></i>
                                Denial Resolver
                            </button>
                            <button data-view="code-checker" class="nav-item w-full text-left">
                                <i class="fas fa-code w-5 mr-3"></i>
                                Code Checker
                            </button>
                            <button data-view="quality-check" class="nav-item w-full text-left">
                                <i class="fas fa-clipboard-check w-5 mr-3"></i>
                                Quality Auditor
                            </button>
                            <button data-view="learning" class="nav-item w-full text-left">
                                <i class="fas fa-graduation-cap w-5 mr-3"></i>
                                Learning Hub
                            </button>
                            <button data-view="dashboard" class="nav-item w-full text-left">
                                <i class="fas fa-chart-line w-5 mr-3"></i>
                                Analytics Dashboard
                            </button>
                        </nav>
                        
                        <div class="mt-8 pt-6 border-t border-slate-700">
                            <h3 class="text-sm font-semibold text-slate-400 mb-3">System Status</h3>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-300">AI Model</span>
                                    <span class="text-xs px-2 py-1 rounded-full bg-blue-900/30 text-blue-400">Gemini 1.5</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-300">Validation Rules</span>
                                    <span class="text-xs px-2 py-1 rounded-full bg-green-900/30 text-green-400">Active</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-300">Accuracy Mode</span>
                                    <span class="text-xs px-2 py-1 rounded-full bg-purple-900/30 text-purple-400">Strict</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="lg:col-span-9">
                    <!-- Denial Resolver -->
                    <div id="resolver" class="section active">
                        <div class="main-card p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-2xl font-bold text-white">AI Denial Resolver</h2>
                                    <p class="text-slate-400">Extract denial codes and generate precise resolution protocols</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs text-slate-400">Accuracy:</span>
                                    <span class="text-sm font-bold text-green-400">High</span>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">
                                        <i class="fas fa-file-medical-alt mr-2"></i>
                                        Paste Denial Details
                                    </label>
                                    <div class="relative">
                                        <textarea id="denialInput" rows="6" class="w-full font-mono text-sm" 
                                                  placeholder="Example: Payer: BCBS PPO (ID: X12345). Claim #CRX-9213 for CPT 99213 denied on 01/15/2025. Reason: CO-29 - Claim not filed within required timeframe. DOS: 10/15/2024. Amount: $150.00">
Payer: BCBS PPO (ID: X12345). Claim #CRX-9213 for CPT 99213 denied on 01/15/2025. Reason: CO-29 - Claim not filed within required timeframe. DOS: 10/15/2024. Amount: $150.00.</textarea>
                                        <div class="absolute bottom-3 right-3 text-xs text-slate-500">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Include payer, code, dates, amounts
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-2">Denial Category</label>
                                        <select id="denialCategory" class="w-full">
                                            <option value="">Auto-detect (Recommended)</option>
                                            <option value="timely">Timely Filing</option>
                                            <option value="medical">Medical Necessity</option>
                                            <option value="coding">Coding/CPT</option>
                                            <option value="eligibility">Eligibility</option>
                                            <option value="billing">Billing Errors</option>
                                            <option value="authorization">Authorization</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-2">Payer Type</label>
                                        <select id="payerType" class="w-full">
                                            <option value="">Auto-detect</option>
                                            <option value="commercial">Commercial (BCBS, UHC, Aetna)</option>
                                            <option value="medicare">Medicare</option>
                                            <option value="medicaid">Medicaid</option>
                                            <option value="tricare">Tricare</option>
                                            <option value="workers">Workers Comp</option>
                                            <option value="auto">Auto Insurance</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="flex flex-col sm:flex-row gap-3">
                                    <button id="resolveBtn" class="btn-primary flex-1">
                                        <span id="resolveBtnText">
                                            <i class="fas fa-robot mr-2"></i>
                                            Analyze & Generate Protocol
                                        </span>
                                        <div class="spinner hidden" id="resolveSpinner"></div>
                                    </button>
                                    <button id="quickAnalyzeBtn" class="btn-primary bg-purple-600 hover:bg-purple-700">
                                        <i class="fas fa-bolt mr-2"></i>
                                        Quick Analysis
                                    </button>
                                    <button id="validateBtn" class="btn-primary bg-green-600 hover:bg-green-700">
                                        <i class="fas fa-check-double mr-2"></i>
                                        Validate
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Results Section -->
                        <div id="resolutionResults" class="main-card p-6 mt-6 hidden">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold text-white">
                                    <i class="fas fa-clipboard-list mr-2"></i>
                                    Resolution Protocol
                                </h3>
                                <div class="flex items-center space-x-4">
                                    <span class="text-sm text-slate-400">Confidence:</span>
                                    <span id="confidenceBadge" class="px-3 py-1 rounded-full text-sm font-bold"></span>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <!-- Extracted Information -->
                                <div class="lg:col-span-2">
                                    <div class="bg-slate-800 rounded-xl p-5 mb-6">
                                        <h4 class="font-bold text-white mb-4 flex items-center">
                                            <i class="fas fa-search mr-2 text-blue-400"></i>
                                            Extracted Information
                                        </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <p class="text-sm text-slate-400">Payer Identified</p>
                                                <p id="extractedPayer" class="text-white font-medium flex items-center">
                                                    <span>--</span>
                                                    <span id="payerValidation" class="validation-badge hidden"></span>
                                                </p>
                                            </div>
                                            <div>
                                                <p class="text-sm text-slate-400">Denial Code</p>
                                                <p id="extractedCode" class="text-white font-medium flex items-center">
                                                    <span>--</span>
                                                    <span id="codeValidation" class="validation-badge hidden"></span>
                                                </p>
                                            </div>
                                            <div>
                                                <p class="text-sm text-slate-400">Category</p>
                                                <p id="extractedCategory" class="text-white font-medium">--</p>
                                            </div>
                                            <div>
                                                <p class="text-sm text-slate-400">Complexity</p>
                                                <p id="extractedComplexity" class="text-white font-medium">--</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Resolution Steps -->
                                    <div id="protocolSteps" class="space-y-4"></div>
                                </div>

                                <!-- Side Panel -->
                                <div class="space-y-6">
                                    <!-- Confidence Score -->
                                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-5 border border-slate-700">
                                        <h4 class="font-bold text-white mb-3">AI Confidence Analysis</h4>
                                        <div class="text-center mb-4">
                                            <div class="accuracy-score" id="aiConfidence">--</div>
                                            <p class="text-sm text-slate-400 mt-1" id="confidenceSummary"></p>
                                        </div>
                                        <div class="accuracy-meter">
                                            <div id="accuracyFill" class="accuracy-fill" style="width: 0%"></div>
                                            <div class="accuracy-marker" style="left: 50%"></div>
                                            <div class="accuracy-marker" style="left: 75%"></div>
                                            <div class="accuracy-marker" style="left: 90%"></div>
                                        </div>
                                        <div class="flex justify-between text-xs text-slate-500 mt-2">
                                            <span>Low</span>
                                            <span>Medium</span>
                                            <span>High</span>
                                            <span>Excellent</span>
                                        </div>
                                    </div>

                                    <!-- Validation Panel -->
                                    <div class="bg-slate-800 rounded-xl p-5">
                                        <h4 class="font-bold text-white mb-3 flex items-center">
                                            <i class="fas fa-shield-alt mr-2 text-green-400"></i>
                                            Validation Results
                                        </h4>
                                        <div class="space-y-3">
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm text-slate-300">Data Completeness</span>
                                                <span id="completenessScore" class="text-sm font-bold">--</span>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm text-slate-300">Code Validation</span>
                                                <span id="codeScore" class="text-sm font-bold">--</span>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm text-slate-300">Logic Accuracy</span>
                                                <span id="logicScore" class="text-sm font-bold">--</span>
                                            </div>
                                            <div class="pt-3 border-t border-slate-700">
                                                <div class="flex items-center justify-between">
                                                    <span class="text-sm font-semibold text-white">Overall Accuracy</span>
                                                    <span id="overallAccuracy" class="text-lg font-bold text-green-400">--</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Actions -->
                                    <div class="space-y-3">
                                        <button id="saveProtocolBtn" class="btn-primary w-full bg-green-600 hover:bg-green-700">
                                            <i class="fas fa-save mr-2"></i>
                                            Save to Dashboard
                                        </button>
                                        <button id="exportBtn" class="btn-primary w-full bg-blue-600 hover:bg-blue-700">
                                            <i class="fas fa-download mr-2"></i>
                                            Export Protocol
                                        </button>
                                        <button id="appealBtn" class="btn-primary w-full bg-purple-600 hover:bg-purple-700">
                                            <i class="fas fa-file-contract mr-2"></i>
                                            Generate Appeal
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Error Display -->
                        <div id="errorDisplay" class="main-card p-6 mt-6 bg-red-900/20 border-red-700 hidden">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-red-400 text-xl mt-1 mr-3"></i>
                                <div>
                                    <h4 class="font-bold text-red-400 mb-2">Analysis Issues Detected</h4>
                                    <p id="errorMessage" class="text-slate-300 mb-3"></p>
                                    <div id="errorSuggestions" class="text-sm text-slate-400 space-y-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other sections (Code Checker, Quality Auditor, etc.) would go here -->
                    <!-- For brevity, I'm focusing on the Denial Resolver accuracy improvements -->
                </div>
            </div>
        </main>

        <!-- Toast Container -->
        <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    </div>

    <script>
        // Configuration
        const API_KEY = ""; // Add your Gemini API key here
        
        // Medical billing knowledge base for validation
        const MEDICAL_KNOWLEDGE = {
            commonDenialCodes: {
                "CO-29": { name: "Time limit for filing has expired", category: "timely", complexity: "medium" },
                "CO-45": { name: "Charge exceeds fee schedule", category: "billing", complexity: "low" },
                "CO-97": { name: "Payment adjusted", category: "payment", complexity: "low" },
                "CO-16": { name: "Claim/service lacks information", category: "documentation", complexity: "low" },
                "CO-4": { name: "Procedure code inconsistent with modifier", category: "coding", complexity: "medium" },
                "CO-22": { name: "This care may be covered by another payer", category: "coordination", complexity: "high" },
                "CO-109": { name: "Claim not covered by this payer", category: "eligibility", complexity: "high" },
                "CO-11": { name: "Diagnosis inconsistent with procedure", category: "medical", complexity: "high" },
                "CO-12": { name: "Services not documented", category: "documentation", complexity: "medium" },
                "CO-15": { name: "Authorization missing", category: "authorization", complexity: "high" }
            },
            
            payers: {
                "BCBS": ["BCBS", "Blue Cross", "Blue Shield"],
                "UHC": ["UnitedHealthcare", "UHC", "United Health"],
                "AETNA": ["Aetna"],
                "CIGNA": ["Cigna"],
                "MEDICARE": ["Medicare", "CMS"],
                "MEDICAID": ["Medicaid"],
                "TRICARE": ["Tricare", "Military"],
                "HUMANA": ["Humana"]
            },
            
            validationRules: {
                requiredFields: ["payer", "code", "date", "amount"],
                codeFormat: /^(CO|PR|OA|PI)-\d+$/i,
                dateFormats: [
                    /\d{1,2}\/\d{1,2}\/\d{4}/, // MM/DD/YYYY
                    /\d{4}-\d{1,2}-\d{1,2}/, // YYYY-MM-DD
                    /\d{1,2}-\d{1,2}-\d{4}/  // MM-DD-YYYY
                ],
                amountPattern: /\$\d+[\.,]?\d*/,
                claimNumberPattern: /(?:claim|#|no\.?)\s*([A-Z0-9\-]+)/i
            },
            
            complexityFactors: {
                high: ["authorization", "medical", "eligibility", "coordination"],
                medium: ["timely", "coding", "documentation"],
                low: ["billing", "payment", "other"]
            }
        };

        // Enhanced system prompts for accuracy
        const ENHANCED_PROMPTS = {
            denialAnalysis: `You are a certified medical billing specialist with 15 years of experience. Analyze denial text with extreme precision.

CRITICAL INSTRUCTIONS:
1. Extract information with 99% accuracy - double-check every detail
2. If ANY information is missing or unclear, DO NOT guess - mark as "Unclear/Incomplete"
3. For confidence scoring: Only assign high confidence (90%+) if ALL data points are clear and validated
4. For missing critical data (payer, code, date), confidence must be below 70%
5. Provide specific validation feedback on what's missing

REQUIRED OUTPUT FORMAT (STRICT JSON):
{
  "extractedData": {
    "payer": "EXACT payer name from text or 'Unclear'",
    "denialCode": "EXACT code like CO-29 or 'Not found'",
    "claimNumber": "Claim # or 'Not found'",
    "dateOfService": "MM/DD/YYYY or 'Not found'",
    "denialDate": "MM/DD/YYYY or 'Not found'",
    "amount": "$ amount or 'Not found'",
    "procedureCode": "CPT code or 'Not found'",
    "diagnosisCode": "DX code or 'Not found'"
  },
  "validation": {
    "dataCompleteness": "percentage 0-100 based on required fields present",
    "clarityScore": "percentage 0-100 based on text clarity",
    "missingCriticalData": ["list of missing critical fields"],
    "confidenceFactors": ["list of factors affecting confidence"]
  },
  "analysis": {
    "category": "timely|medical|coding|eligibility|billing|authorization|other",
    "complexity": "low|medium|high",
    "requiresAppeal": true|false,
    "estimatedResolutionTime": "hours|days|weeks",
    "successProbability": "percentage 0-100"
  },
  "protocol": {
    "title": "Specific, actionable title",
    "summary": "One-line summary",
    "confidence": "percentage 0-100 (BE CONSERVATIVE)",
    "confidenceReasoning": "Detailed explanation of confidence score",
    "steps": [
      {
        "step": 1,
        "title": "Specific action title",
        "action": "Detailed, specific action",
        "requiredDocs": ["list of specific documents"],
        "timeEstimate": "e.g., 15 minutes, 1 hour, 1 day",
        "critical": true|false
      }
    ]
  }
}

VALIDATION RULES:
- Payer must be explicitly mentioned
- Denial code must match pattern CO-XX, PR-XX, etc.
- Dates must be in the text
- Amounts must be in the text
- If text only says "insurance" without name, payer = "Unclear"
- If no code pattern found, denialCode = "Not found"

Now analyze this denial text:`,

            qualityCheck: `You are a medical billing compliance auditor with 20 years experience. Audit follow-up notes with extreme strictness.

CRITICAL RULES:
1. Score starts at 50% and points are ADDED for completeness
2. Deduct points aggressively for missing information
3. Only high-quality, complete notes get 80%+
4. Notes mentioning only insurance name without details get MAX 40%

SCORING RUBRIC:
+20% - Includes specific denial code
+15% - Includes exact dates (service, denial, follow-up)
+15% - Includes dollar amounts
+15% - Includes contact names/IDs
+10% - Includes next steps with deadlines
+10% - Includes reference numbers
+5%  - Professional tone
+5%  - Clear action items
+5%  - Audit-ready formatting

RISK LEVELS:
- 90-100%: LOW RISK - Complete, professional, audit-ready
- 75-89%: MEDIUM RISK - Missing some details but acceptable
- 60-74%: MEDIUM-HIGH RISK - Missing important details
- 40-59%: HIGH RISK - Incomplete, needs major improvement
- 0-39%: CRITICAL RISK - Unacceptable, requires complete rewrite

OUTPUT FORMAT (STRICT JSON):
{
  "score": 0-100,
  "riskLevel": "LOW|MEDIUM|MEDIUM-HIGH|HIGH|CRITICAL",
  "missingCritical": ["list of missing critical elements"],
  "strengths": ["list of strong points"],
  "weaknesses": ["list of weaknesses"],
  "suggestions": [
    {
      "priority": "critical|high|medium|low",
      "suggestion": "specific improvement",
      "impact": "points this would add to score"
    }
  ],
  "auditReadiness": "percentage 0-100",
  "complianceScore": "percentage 0-100"
}

Now audit this note against the denial context:`
        };

        // State
        let currentAnalysis = null;
        let validationResults = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setupValidationRules();
        });

        function setupEventListeners() {
            // Main analysis button
            document.getElementById('resolveBtn').addEventListener('click', enhancedAnalyzeDenial);
            document.getElementById('quickAnalyzeBtn').addEventListener('click', quickAnalyze);
            document.getElementById('validateBtn').addEventListener('click', validateInput);
            
            // Action buttons
            document.getElementById('saveProtocolBtn').addEventListener('click', saveProtocol);
            document.getElementById('exportBtn').addEventListener('click', exportProtocol);
            document.getElementById('appealBtn').addEventListener('click', generateAppeal);
        }

        function setupValidationRules() {
            // Real-time validation on input
            const denialInput = document.getElementById('denialInput');
            denialInput.addEventListener('input', function() {
                validateDenialText(this.value);
            });
        }

        function validateDenialText(text) {
            const issues = [];
            const strengths = [];
            
            // Check for required elements
            if (!text) return { valid: false, issues: ["No text entered"] };
            
            // Check for payer
            const hasPayer = /(payer|insurance|ins\.?)\s*:?\s*([A-Za-z\s]+)/i.test(text);
            if (!hasPayer) issues.push("No clear payer identification");
            else strengths.push("Payer mentioned");
            
            // Check for denial code
            const hasCode = /(CO|PR|OA|PI)[-\s]\d+/i.test(text);
            if (!hasCode) issues.push("No denial code found (CO-XX, PR-XX, etc.)");
            else strengths.push("Denial code found");
            
            // Check for dates
            const hasDate = /\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}/.test(text);
            if (!hasDate) issues.push("No dates found (MM/DD/YYYY format)");
            else strengths.push("Dates present");
            
            // Check for amounts
            const hasAmount = /\$\d+[\.,]?\d*/.test(text);
            if (!hasAmount) issues.push("No dollar amounts found");
            else strengths.push("Amount specified");
            
            // Check for claim number
            const hasClaim = /claim\s*#?\s*([A-Z0-9\-]+)/i.test(text);
            if (!hasClaim) issues.push("No claim number found");
            else strengths.push("Claim number included");
            
            return {
                valid: issues.length < 3,
                issues,
                strengths,
                completeness: Math.round((strengths.length / 5) * 100)
            };
        }

        async function enhancedAnalyzeDenial() {
            const input = document.getElementById('denialInput').value.trim();
            const category = document.getElementById('denialCategory').value;
            const payerType = document.getElementById('payerType').value;
            
            if (!input) {
                showToast("Please enter denial details", "error");
                return;
            }

            // Show loading
            const btn = document.getElementById('resolveBtn');
            const spinner = document.getElementById('resolveSpinner');
            const btnText = document.getElementById('resolveBtnText');
            
            btn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.innerHTML = '<i class="fas fa-cogs mr-2"></i>Analyzing with High Accuracy...';

            try {
                // First validate locally
                const localValidation = validateDenialText(input);
                
                // Prepare enhanced prompt with context
                let enhancedPrompt = ENHANCED_PROMPTS.denialAnalysis;
                if (category) enhancedPrompt += `\n\nCategory hint: ${category}`;
                if (payerType) enhancedPrompt += `\n\nPayer type: ${payerType}`;
                enhancedPrompt += `\n\nDenial text: "${input}"`;
                
                // Call API
                const result = await callGeminiAPI(enhancedPrompt, null, true);
                
                // Enhance with local validation
                result.localValidation = localValidation;
                
                // Calculate enhanced confidence
                result.protocol.confidence = calculateEnhancedConfidence(result, localValidation);
                
                currentAnalysis = result;
                validationResults = localValidation;
                
                displayEnhancedResults(result, localValidation);
                showToast(`Analysis complete with ${result.protocol.confidence}% confidence`, "success");
                
            } catch (error) {
                console.error('Analysis error:', error);
                
                // Fallback to intelligent analysis
                const fallbackResult = intelligentFallbackAnalysis(input);
                currentAnalysis = fallbackResult;
                validationResults = fallbackResult.localValidation;
                
                displayEnhancedResults(fallbackResult, fallbackResult.localValidation);
                showToast("Using enhanced local analysis", "warning");
                
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
                btnText.innerHTML = '<i class="fas fa-robot mr-2"></i>Analyze & Generate Protocol';
            }
        }

        function calculateEnhancedConfidence(apiResult, localValidation) {
            let confidence = apiResult.protocol.confidence || 70;
            
            // Adjust based on local validation
            if (localValidation.issues.length > 0) {
                // Deduct 5% per major issue
                confidence -= (localValidation.issues.length * 5);
            }
            
            // Adjust based on data completeness
            if (apiResult.validation.dataCompleteness < 70) {
                confidence -= (70 - apiResult.validation.dataCompleteness) / 2;
            }
            
            // Adjust based on clarity
            if (apiResult.validation.clarityScore < 80) {
                confidence -= (80 - apiResult.validation.clarityScore) / 3;
            }
            
            // Ensure bounds
            confidence = Math.max(30, Math.min(98, confidence));
            
            return Math.round(confidence);
        }

        function intelligentFallbackAnalysis(text) {
            // Extract information using regex patterns
            const extracted = extractInformation(text);
            const validation = validateDenialText(text);
            
            // Determine category
            const category = determineCategory(text);
            const complexity = determineComplexity(category);
            
            // Generate protocol based on extracted data
            const protocol = generateProtocolFromData(extracted, category, complexity);
            
            return {
                extractedData: extracted,
                validation: {
                    dataCompleteness: validation.completeness || 50,
                    clarityScore: calculateClarity(text),
                    missingCriticalData: validation.issues,
                    confidenceFactors: validation.issues
                },
                analysis: {
                    category,
                    complexity,
                    requiresAppeal: requiresAppeal(category),
                    estimatedResolutionTime: estimateResolutionTime(complexity),
                    successProbability: estimateSuccessProbability(extracted)
                },
                protocol,
                localValidation: validation
            };
        }

        function extractInformation(text) {
            const result = {
                payer: "Unclear",
                denialCode: "Not found",
                claimNumber: "Not found",
                dateOfService: "Not found",
                denialDate: "Not found",
                amount: "Not found",
                procedureCode: "Not found",
                diagnosisCode: "Not found"
            };
            
            // Extract payer
            const payerMatch = text.match(/(?:payer|insurance|ins\.?)\s*:?\s*([A-Za-z\s]+(?:PPO|HMO|POS)?)/i);
            if (payerMatch) result.payer = payerMatch[1].trim();
            
            // Extract denial code
            const codeMatch = text.match(/(CO|PR|OA|PI)[-\s](\d+)/i);
            if (codeMatch) result.denialCode = `${codeMatch[1].toUpperCase()}-${codeMatch[2]}`;
            
            // Extract claim number
            const claimMatch = text.match(/(?:claim|#|no\.?)\s*([A-Z0-9\-]+)/i);
            if (claimMatch) result.claimNumber = claimMatch[1];
            
            // Extract dates
            const dateMatches = text.match(/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}/g);
            if (dateMatches) {
                if (dateMatches[0]) result.dateOfService = dateMatches[0];
                if (dateMatches[1]) result.denialDate = dateMatches[1];
            }
            
            // Extract amount
            const amountMatch = text.match(/\$(\d+[\.,]?\d*)/);
            if (amountMatch) result.amount = `$${amountMatch[1]}`;
            
            // Extract CPT
            const cptMatch = text.match(/(?:CPT|code)\s*(\d{5})/i);
            if (cptMatch) result.procedureCode = cptMatch[1];
            
            // Extract DX
            const dxMatch = text.match(/(?:DX|diagnosis)\s*([A-Z]\d{2}(?:\.\d+)?)/i);
            if (dxMatch) result.diagnosisCode = dxMatch[1];
            
            return result;
        }

        function determineCategory(text) {
            const textLower = text.toLowerCase();
            
            if (textLower.includes('time') || textLower.includes('filing') || textLower.includes('expired')) {
                return 'timely';
            } else if (textLower.includes('medical') || textLower.includes('necessity') || textLower.includes('not covered')) {
                return 'medical';
            } else if (textLower.includes('code') || textLower.includes('cpt') || textLower.includes('modifier')) {
                return 'coding';
            } else if (textLower.includes('eligible') || textLower.includes('coverage') || textLower.includes('terminated')) {
                return 'eligibility';
            } else if (textLower.includes('authorization') || textLower.includes('pre-cert') || textLower.includes('prior auth')) {
                return 'authorization';
            } else if (textLower.includes('fee') || textLower.includes('amount') || textLower.includes('billing')) {
                return 'billing';
            }
            
            return 'other';
        }

        function generateProtocolFromData(data, category, complexity) {
            const baseSteps = [];
            let title = "Resolution Protocol";
            let confidence = 70;
            
            // Customize based on category
            switch(category) {
                case 'timely':
                    title = "Timely Filing Exception Protocol";
                    baseSteps.push(
                        {
                            step: 1,
                            title: "Verify Filing Timeline",
                            action: `Check if ${data.dateOfService} is within ${data.payer}'s filing limit (typically 90-180 days)`,
                            requiredDocs: ["Provider agreement", "Submission proof"],
                            timeEstimate: "15 minutes",
                            critical: true
                        },
                        {
                            step: 2,
                            title: "Gather Exception Evidence",
                            action: "Collect proof of timely submission, EOBs, and any correspondence",
                            requiredDocs: ["Submission confirmation", "EOB copies"],
                            timeEstimate: "30 minutes",
                            critical: true
                        }
                    );
                    confidence = data.dateOfService !== "Not found" ? 85 : 65;
                    break;
                    
                case 'medical':
                    title = "Medical Necessity Appeal Protocol";
                    baseSteps.push(
                        {
                            step: 1,
                            title: "Review Medical Records",
                            action: "Ensure documentation supports medical necessity for the procedure",
                            requiredDocs: ["Progress notes", "Test results", "Doctor's notes"],
                            timeEstimate: "1 hour",
                            critical: true
                        }
                    );
                    confidence = 75;
                    break;
                    
                default:
                    baseSteps.push(
                        {
                            step: 1,
                            title: "Review Denial Details",
                            action: "Verify all information and identify root cause",
                            requiredDocs: ["Complete denial details"],
                            timeEstimate: "20 minutes",
                            critical: true
                        }
                    );
            }
            
            return {
                title,
                summary: `Resolve ${category} denial for ${data.payer}`,
                confidence,
                confidenceReasoning: "Based on data completeness and category analysis",
                steps: baseSteps
            };
        }

        function displayEnhancedResults(result, validation) {
            const resultsDiv = document.getElementById('resolutionResults');
            resultsDiv.classList.remove('hidden');
            
            // Update extracted information
            const data = result.extractedData;
            document.getElementById('extractedPayer').innerHTML = `
                ${data.payer}
                <span class="validation-badge ${data.payer === 'Unclear' ? 'validation-error' : 'validation-success'}">
                    ${data.payer === 'Unclear' ? 'Needs Clarification' : 'Valid'}
                </span>
            `;
            
            document.getElementById('extractedCode').innerHTML = `
                ${data.denialCode}
                <span class="validation-badge ${data.denialCode === 'Not found' ? 'validation-error' : 'validation-success'}">
                    ${data.denialCode === 'Not found' ? 'Missing' : 'Valid'}
                </span>
            `;
            
            document.getElementById('extractedCategory').textContent = result.analysis.category;
            document.getElementById('extractedComplexity').textContent = result.analysis.complexity;
            
            // Update confidence
            const confidence = result.protocol.confidence;
            document.getElementById('aiConfidence').textContent = `${confidence}%`;
            document.getElementById('confidenceSummary').textContent = result.protocol.confidenceReasoning;
            
            // Update confidence badge
            const badge = document.getElementById('confidenceBadge');
            badge.textContent = confidence >= 90 ? 'High' : confidence >= 70 ? 'Medium' : 'Low';
            badge.className = `px-3 py-1 rounded-full text-sm font-bold ${confidence >= 90 ? 'bg-green-900/30 text-green-400' : confidence >= 70 ? 'bg-yellow-900/30 text-yellow-400' : 'bg-red-900/30 text-red-400'}`;
            
            // Update accuracy meter
            document.getElementById('accuracyFill').style.width = `${confidence}%`;
            
            // Update validation scores
            document.getElementById('completenessScore').textContent = `${result.validation.dataCompleteness}%`;
            document.getElementById('codeScore').textContent = data.denialCode !== 'Not found' ? 'Valid' : 'Invalid';
            document.getElementById('logicScore').textContent = confidence >= 70 ? 'High' : 'Medium';
            document.getElementById('overallAccuracy').textContent = `${confidence}%`;
            
            // Display steps
            const stepsContainer = document.getElementById('protocolSteps');
            stepsContainer.innerHTML = '';
            
            if (result.protocol.steps && result.protocol.steps.length > 0) {
                result.protocol.steps.forEach(step => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'bg-slate-800 rounded-xl p-5';
                    stepDiv.innerHTML = `
                        <div class="flex items-start">
                            <div class="step-number mr-4">${step.step}</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-white mb-2">${step.title}</h4>
                                <p class="text-slate-300 mb-3">${step.action}</p>
                                <div class="flex flex-wrap gap-2 mb-3">
                                    ${step.requiredDocs.map(doc => `
                                        <span class="px-2 py-1 bg-slate-700 rounded text-xs text-slate-300">
                                            <i class="fas fa-file-alt mr-1"></i>${doc}
                                        </span>
                                    `).join('')}
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-slate-400">
                                        <i class="far fa-clock mr-1"></i>
                                        ${step.timeEstimate}
                                    </span>
                                    ${step.critical ? `
                                        <span class="px-2 py-1 bg-red-900/30 text-red-400 rounded text-xs font-medium">
                                            <i class="fas fa-exclamation-circle mr-1"></i>Critical
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    stepsContainer.appendChild(stepDiv);
                });
            }
            
            // Show/hide error display based on validation
            const errorDisplay = document.getElementById('errorDisplay');
            if (validation.issues.length > 0) {
                errorDisplay.classList.remove('hidden');
                document.getElementById('errorMessage').textContent = 
                    `Found ${validation.issues.length} issue(s) with the input data`;
                
                const suggestionsDiv = document.getElementById('errorSuggestions');
                suggestionsDiv.innerHTML = validation.issues.map(issue => `
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-circle text-red-400 text-xs mt-1 mr-2"></i>
                        <span>${issue}</span>
                    </div>
                `).join('');
            } else {
                errorDisplay.classList.add('hidden');
            }
        }

        // Quick analysis with local validation only
        function quickAnalyze() {
            const input = document.getElementById('denialInput').value.trim();
            if (!input) {
                showToast("Please enter denial details", "error");
                return;
            }
            
            const result = intelligentFallbackAnalysis(input);
            currentAnalysis = result;
            validationResults = result.localValidation;
            
            displayEnhancedResults(result, result.localValidation);
            showToast("Quick analysis complete", "success");
        }

        // Validate input only
        function validateInput() {
            const input = document.getElementById('denialInput').value.trim();
            if (!input) {
                showToast("Please enter denial details", "error");
                return;
            }
            
            const validation = validateDenialText(input);
            
            // Show validation results
            showToast(`Validation: ${validation.completeness}% complete`, 
                     validation.valid ? "success" : "error");
            
            // Update UI with validation info
            const issues = validation.issues.map(issue => 
                `<div class="suggestion-item suggestion-critical">
                    <i class="fas fa-times-circle text-red-400 mr-2"></i>
                    ${issue}
                </div>`
            ).join('');
            
            const strengths = validation.strengths.map(strength => 
                `<div class="suggestion-item suggestion-helpful">
                    <i class="fas fa-check-circle text-green-400 mr-2"></i>
                    ${strength}
                </div>`
            ).join('');
            
            alert(`Validation Results:\n\nIssues:\n${issues}\n\nStrengths:\n${strengths}\n\nCompleteness: ${validation.completeness}%`);
        }

        // Helper functions
        function showToast(message, type = "success") {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type} animate-slideIn`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        async function callGeminiAPI(prompt, systemInstruction, expectJSON = true) {
            if (!API_KEY) {
                throw new Error("API key not configured");
            }
            
            const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent";
            
            const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.2, // Lower temperature for more consistent results
                        topP: 0.8,
                        topK: 40,
                        maxOutputTokens: 2048,
                        responseMimeType: expectJSON ? "application/json" : "text/plain"
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            
            if (expectJSON) {
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
                throw new Error("Invalid JSON response");
            }
            
            return text;
        }

        function saveProtocol() {
            if (!currentAnalysis) {
                showToast("No protocol to save", "error");
                return;
            }
            
            // Save to localStorage for demo
            const savedProtocols = JSON.parse(localStorage.getItem('claimfix_protocols') || '[]');
            savedProtocols.push({
                ...currentAnalysis,
                savedAt: new Date().toISOString(),
                id: Date.now()
            });
            
            localStorage.setItem('claimfix_protocols', JSON.stringify(savedProtocols));
            showToast("Protocol saved successfully!", "success");
        }

        function exportProtocol() {
            if (!currentAnalysis) {
                showToast("No protocol to export", "error");
                return;
            }
            
            const dataStr = JSON.stringify(currentAnalysis, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `claimfix_protocol_${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast("Protocol exported as JSON", "success");
        }

        function generateAppeal() {
            if (!currentAnalysis) {
                showToast("No analysis to base appeal on", "error");
                return;
            }
            
            // Generate appeal letter template
            const data = currentAnalysis.extractedData;
            const appealTemplate = `
APPEAL LETTER

To: ${data.payer || 'Insurance Provider'}
Re: Appeal of Denial - ${data.claimNumber || 'Claim'} | ${data.denialCode || 'Denial'}

Dear Claims Department,

We are formally appealing the denial of the above-referenced claim.

Claim Details:
- Patient: [Patient Name]
- Date of Service: ${data.dateOfService}
- Procedure: ${data.procedureCode || '[Procedure]'}
- Amount: ${data.amount}
- Denial Code: ${data.denialCode}
- Denial Date: ${data.denialDate}

Basis for Appeal:
${currentAnalysis.analysis.category === 'timely' ? 
'Our records indicate this claim was submitted within the timely filing window specified in our provider agreement.' :
'We believe this service was medically necessary and appropriately documented.'}

Supporting Documentation:
1. Original claim submission confirmation
2. Medical records supporting medical necessity
3. Provider agreement terms
4. All prior correspondence

We request reconsideration and reprocessing of this claim. Please contact us within 30 days if additional information is required.

Sincerely,
[Your Name]
AR Specialist
[Practice Name]
[Contact Information]
            `;
            
            // Open in new window for printing
            const newWindow = window.open();
            newWindow.document.write(`
                <html>
                <head>
                    <title>Appeal Letter - ${data.denialCode || 'Denial'}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        .header { border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .content { white-space: pre-wrap; margin: 20px 0; }
                        .signature { margin-top: 60px; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="content">${appealTemplate}</div>
                    <button onclick="window.print()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">
                        Print Letter
                    </button>
                </body>
                </html>
            `);
            
            showToast("Appeal letter generated", "success");
        }

        // Utility functions
        function calculateClarity(text) {
            let score = 50;
            
            // Add points for clarity indicators
            if (text.includes(':')) score += 10; // Structured format
            if (text.match(/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}/)) score += 15; // Has dates
            if (text.match(/\$\d+/)) score += 10; // Has amounts
            if (text.match(/CO-\d+/i)) score += 15; // Has denial code
            
            return Math.min(100, score);
        }

        function requiresAppeal(category) {
            return ['timely', 'medical', 'authorization'].includes(category);
        }

        function estimateResolutionTime(complexity) {
            switch(complexity) {
                case 'high': return '1-2 weeks';
                case 'medium': return '3-5 days';
                case 'low': return '1-2 days';
                default: return '3-5 days';
            }
        }

        function estimateSuccessProbability(data) {
            let probability = 70;
            
            // Adjust based on data completeness
            const fields = Object.values(data);
            const completeFields = fields.filter(f => f !== "Not found" && f !== "Unclear").length;
            const completeness = (completeFields / fields.length) * 100;
            
            probability = Math.min(95, Math.max(30, completeness));
            
            return Math.round(probability);
        }

        function determineComplexity(category) {
            if (MEDICAL_KNOWLEDGE.complexityFactors.high.includes(category)) return 'high';
            if (MEDICAL_KNOWLEDGE.complexityFactors.medium.includes(category)) return 'medium';
            return 'low';
        }
    </script>
</body>
</html>